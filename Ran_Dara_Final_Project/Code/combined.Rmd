---
title: "Contributors to Teen Birth"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Step 0: Load necessary libraries and datasets
Load libraries that we use
```{r}
#data analysis
library(tidyverse)
library(broom)
library(ggplot2)
library(readxl)

#mapping
library(maptools)
library(tmap) 
library(sf)
library(maps)
library(dplyr)
```

# Step 1: Load datasets
We consider three datasets:
*Teen birth data by county
*Education by county
*Unemployment rate by county

```{r}
teen_birth <- read_csv("../Data/teen_birth.csv")
Education <- read_csv("../Data/Education.csv")
Unemployment <- read_excel("../Data/Unemployment.xls", skip = 7)
state_regions <- read_csv("../Data/state_regions.csv")
```

# Step 2: Clean datasets for ease of use
Looking at the years that the three datasets have in common, we chose to use 2015 data for teen_birth and Unemployment datases. For Education, we use the 2013-2017 average.

```{r}
Education <- Education %>%
  select(1, 44, 45, 46, 47) %>%
  mutate(`FIPS Code` = as.integer(`FIPS Code`))

teen_birth <- teen_birth %>%
  filter(Year=="2015") %>%
  select("Combined FIPS Code", "Birth Rate", "Year")

unemployment2015 <- Unemployment %>%
  rename(FIPS = FIPStxt) %>%
  select(FIPS, State, Area_name, 39:42) %>%
  rename(LaborForce = Civilian_labor_force_2015, 
         Employed = Employed_2015, 
         Unemployed = Unemployed_2015, 
         UnemploymentRate = Unemployment_rate_2015) %>%
  mutate(FIPS = as.integer(FIPS))
```

# Step 3: Join datasets into a master dataset
We

```{r}
data <- teen_birth %>%
  inner_join(Education,by = c("Combined FIPS Code"="FIPS Code")) %>%
  inner_join(unemployment2015, by = c("Combined FIPS Code"="FIPS")) %>%
  rename(Less_than_high_school=`Percent of adults with less than a high school diploma, 2013-17`,
         high_school=`Percent of adults with a high school diploma only, 2013-17`,
         some_college=`Percent of adults completing some college or associate's degree, 2013-17`,
         college=`Percent of adults with a bachelor's degree or higher, 2013-17`)

data=data%>%inner_join(state_regions, by=c("State"="State Code"))
```

# Step 4: Plotting birth rates against various education rates and unemployment rates

```{r}
data %>%
  ggplot() +
  geom_point(aes(y=`Birth Rate`, x=`Less_than_high_school`,color=Region,alpha=.1))

data %>%
  ggplot() +
  geom_point(aes(y=`Birth Rate`, x=`high_school`,color=Region,alpha=.1))

data %>%
  ggplot() +
  geom_point(aes(y=`Birth Rate`, x=`some_college`,color=Region,alpha=.1))

data %>%
  ggplot() +
  geom_point(aes(y=`Birth Rate`, x=`college`,color=Region,alpha=.1))

data %>%
  ggplot() +
  geom_point(aes(y=`Birth Rate`, x=`UnemploymentRate`,color=Region,alpha=.1))
```

# Linear model of birth rate as a function of unemployment rate and education
The education data divides the population into four groups: less than high school, high school, college, beyond college. Since the four categories add up to 100%, it is sufficient to only include three of the four rates in the linear model.

```{r}
model = lm(`Birth Rate`~ UnemploymentRate + Less_than_high_school + high_school + college, data = data)

summary(model)
plot(model)
```

#

```{r,echo=FALSE,eval=FALSE}
model = lm(log(`Birth Rate`) ~ UnemploymentRate + Less_than_high_school + high_school + college, data = data)

summary(model)
plot(model)
```

# 

```{r,echo=FALSE,eval=FALSE}

model = lm(`Birth Rate`~UnemploymentRate+Less_than_high_school+high_school+college+I(UnemploymentRate^2)+I(Less_than_high_school^2)+I(high_school^2)+I(college^2),data=data)

summary(model)
plot(model)
```


```{r,echo=FALSE,eval=FALSE}

model=lm(`Birth Rate`~UnemploymentRate+Less_than_high_school+high_school+college+I(UnemploymentRate^(1/2))+I(Less_than_high_school^(1/2))+I(high_school^(1/2))+I(college^(1/2)),data=data)

summary(model)
plot(model)
```



```{r,echo=FALSE,eval=FALSE}

model=lm(`Birth Rate`~UnemploymentRate+Less_than_high_school+high_school+college+I(log(UnemploymentRate))+I(log(Less_than_high_school))+I(log(high_school))+I(log(college)),data=data)

summary(model)
plot(model)
```


```{r,echo=FALSE,eval=FALSE}
model=lm(`Birth Rate`^(1/2)~UnemploymentRate+Less_than_high_school+high_school+college,data=data)

summary(model)
plot(model)
```

```{r}
data(county.fips)

## merge population data with county.fips to make sure color column is
## ordered correctly.
data=data%>%mutate(`Combined FIPS Code`=as.integer(`Combined FIPS Code`))


```

```{r}
# Load the county data from the maps package
cnty <- st_as_sf(map("county", plot = FALSE, fill = TRUE))
state<-st_as_sf(map("state", plot = FALSE, fill = TRUE))


cnty2 <- cnty %>%
         left_join(county.fips, by=c("ID" = "polyname"))

cnty.data <- inner_join(cnty2, data , by=c("fips"="Combined FIPS Code") )

tm_shape(cnty.data) + tm_fill(col = "Birth Rate", palette = "Greens") +tm_legend(outside = TRUE)+tm_shape(state)+tm_borders()
```



```{r}



data=data%>%mutate(len=nchar(Region))
data%>%ggplot()+geom_boxplot(aes(y=`Birth Rate`,x=fct_reorder(Division,len),color=Region),alpha=.5)+labs(y="Birth Rate",x="Division")+theme(axis.text.x=element_text(angle=45,hjust=1))
```

```{r}
model=lm(`Birth Rate`~UnemploymentRate+Less_than_high_school+high_school+college+Region,data=data)

summary(model)
plot(model)

```